{% extends "base.html" %}

{% block title %}Tasks - Lidya{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
    <div>
        <h1 class="page-title">Your tasks</h1>
        <p class="page-subtitle">Action items from your conversations, all in one place.</p>
    </div>
    <button class="btn btn-primary" onclick="openCreateModal()">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16" style="margin-right: 4px;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
        New task
    </button>
</div>

<!-- Stats -->
<div class="stats-row">
    <div class="stat">
        <span class="stat-value">{{ stats.total }}</span>
        <span class="stat-label">total</span>
    </div>
    <div class="stat pending">
        <span class="stat-value">{{ stats.pending }}</span>
        <span class="stat-label">pending</span>
    </div>
    <div class="stat done">
        <span class="stat-value">{{ stats.done }}</span>
        <span class="stat-label">completed</span>
    </div>
</div>

<!-- Filters -->
<div class="filter-bar">
    <form method="get" id="filter-form" style="display: flex; gap: 12px; flex-wrap: wrap; width: 100%;">
        <input type="text" name="q" class="form-control" placeholder="Search tasks..." value="{{ search_query|default:'' }}" style="flex: 1; min-width: 200px;">
        <select name="status" class="form-control" style="width: auto; min-width: 140px;" onchange="document.getElementById('filter-form').submit();">
            <option value="">All status</option>
            <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
            <option value="done" {% if status_filter == 'done' %}selected{% endif %}>Done</option>
            <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Cancelled</option>
        </select>
        <select name="room" class="form-control" style="width: auto; min-width: 160px;" onchange="document.getElementById('filter-form').submit();">
            <option value="">All rooms</option>
            {% for room in rooms %}
            <option value="{{ room.id }}" {% if room_filter == room.id|stringformat:"i" %}selected{% endif %}>
                {{ room.room_name|default:room.room_id|truncatechars:25 }}
            </option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-primary">Filter</button>
        {% if search_query or status_filter or room_filter %}
        <a href="{% url 'todo_list' %}" class="btn btn-secondary">Clear</a>
        {% endif %}
    </form>
</div>

<!-- Task List -->
<div class="section">
    {% if todos %}
    <div class="card">
        <ul class="todo-list" style="padding: 8px 20px;">
            {% for todo in todos %}
            <li class="todo-item {% if todo.status == 'done' %}done{% elif todo.status == 'cancelled' %}cancelled{% endif %}" id="todo-{{ todo.id }}">
                <div class="todo-checkbox {% if todo.status == 'done' %}checked{% endif %}" onclick="toggleTodo({{ todo.id }}, '{% if todo.status == 'done' %}pending{% else %}done{% endif %}')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
                <div class="todo-content">
                    <div class="todo-title">{{ todo.description }}</div>
                    <div class="todo-meta">
                        {% if todo.room %}{{ todo.room.room_name|default:todo.room.room_id|truncatechars:30 }}{% else %}No room{% endif %}
                        {% if todo.notes %} &middot; {{ todo.notes|truncatechars:50 }}{% endif %}
                    </div>
                    <div class="todo-meta" style="margin-top: 2px;">
                        {{ todo.created_at|date:"M d, Y" }}
                        {% if todo.status == 'cancelled' %} &middot; <span style="color: var(--text-muted);">Cancelled</span>{% endif %}
                    </div>
                </div>
                <div class="todo-actions">
                    {% if todo.status != 'cancelled' and todo.status != 'done' %}
                    <button class="todo-action" onclick="updateStatus({{ todo.id }}, 'cancelled')" title="Cancel">Skip</button>
                    {% endif %}
                    {% if todo.status == 'cancelled' %}
                    <button class="todo-action" onclick="updateStatus({{ todo.id }}, 'pending')" title="Restore">Restore</button>
                    {% endif %}
                    <button class="todo-action danger" onclick="deleteTodo({{ todo.id }})" title="Delete">Delete</button>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% else %}
    <div class="card">
        <div class="empty-state">
            <h3>No tasks found</h3>
            <p>
                {% if search_query or status_filter or room_filter %}
                Try adjusting your filters to see more tasks.
                {% else %}
                Tasks will appear here as they're extracted from your conversations.
                {% endif %}
            </p>
            {% if search_query or status_filter or room_filter %}
            <a href="{% url 'todo_list' %}" class="btn btn-secondary" style="margin-top: 16px;">Clear filters</a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Pagination -->
{% if page_obj.has_other_pages %}
<div class="pagination">
    {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if room_filter %}&room={{ room_filter }}{% endif %}">
        &larr; Previous
    </a>
    {% endif %}

    {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
        <span class="current">{{ num }}</span>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
        <a href="?page={{ num }}{% if search_query %}&q={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if room_filter %}&room={{ room_filter }}{% endif %}">{{ num }}</a>
        {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if room_filter %}&room={{ room_filter }}{% endif %}">
        Next &rarr;
    </a>
    {% endif %}
</div>
{% endif %}

<!-- Create Todo Modal -->
<div class="modal-overlay" id="create-modal" onclick="closeCreateModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3>New task</h3>
            <button class="modal-close" onclick="closeCreateModal()">&times;</button>
        </div>
        <form id="create-form" onsubmit="createTodo(event)">
            <div class="form-group">
                <label class="form-label" for="description">What needs to be done?</label>
                <textarea name="description" id="description" class="form-control" rows="3" required placeholder="Enter task description..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label" for="room_id">Room (optional)</label>
                <select name="room_id" id="room_id" class="form-control">
                    <option value="">No room</option>
                    {% for room in rooms %}
                    <option value="{{ room.id }}">{{ room.room_name|default:room.room_id|truncatechars:40 }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="notes">Notes (optional)</label>
                <input type="text" name="notes" id="notes" class="form-control" placeholder="Any additional context...">
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create task</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .todo-item.cancelled .todo-title {
        color: var(--text-muted);
        text-decoration: line-through;
    }

    .todo-item.cancelled .todo-checkbox {
        opacity: 0.4;
        pointer-events: none;
    }

    /* Modal styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal {
        background: var(--bg-card);
        border-radius: 8px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
        width: 100%;
        max-width: 480px;
        margin: 24px;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border);
    }

    .modal-header h3 {
        font-size: 18px;
        font-weight: 600;
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: var(--text-muted);
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }

    .modal-close:hover {
        color: var(--text);
    }

    .modal form {
        padding: 24px;
    }

    .modal textarea.form-control {
        resize: vertical;
        min-height: 80px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
const API_BASE = '/api/todos';

function openCreateModal() {
    document.getElementById('create-modal').classList.add('active');
    document.getElementById('description').focus();
}

function closeCreateModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('create-modal').classList.remove('active');
    document.getElementById('create-form').reset();
}

async function createTodo(event) {
    event.preventDefault();

    const form = event.target;
    const description = form.description.value.trim();
    const roomId = form.room_id.value || null;
    const notes = form.notes.value.trim();

    if (!description) {
        alert('Please enter a task description');
        return;
    }

    try {
        const response = await fetch(API_BASE, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                description: description,
                room_id: roomId ? parseInt(roomId) : null,
                notes: notes
            })
        });

        if (response.ok) {
            location.reload();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.detail || 'Failed to create task'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to create task');
    }
}

async function toggleTodo(todoId, newStatus) {
    await updateStatus(todoId, newStatus);
}

async function updateStatus(todoId, status) {
    try {
        const response = await fetch(`${API_BASE}/${todoId}/status`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: status })
        });

        if (response.ok) {
            location.reload();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.detail || 'Failed to update status'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to update status');
    }
}

async function deleteTodo(todoId) {
    if (!confirm('Are you sure you want to delete this task?')) {
        return;
    }

    try {
        const response = await fetch(`${API_BASE}/${todoId}`, {
            method: 'DELETE',
        });

        if (response.ok) {
            const row = document.getElementById(`todo-${todoId}`);
            row.style.opacity = '0';
            row.style.transition = 'opacity 0.2s ease';
            setTimeout(() => {
                row.remove();
                const list = document.querySelector('.todo-list');
                if (list && !list.children.length) {
                    location.reload();
                }
            }, 200);
        } else {
            const error = await response.json();
            alert('Error: ' + (error.detail || 'Failed to delete task'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to delete task');
    }
}

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeCreateModal();
    }
});
</script>
{% endblock %}
